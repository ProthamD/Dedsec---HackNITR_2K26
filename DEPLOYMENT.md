# Inventree Deployment Guide

## Merged Deployment (Recommended - Free Tier)

This deployment runs both the backend UI and Mastra AI agents in a single service.

### Architecture
```
Single Render Service
├── Backend (Express + EJS) → Port 3000 (public)
└── Mastra AI Agents       → Port 4111 (internal)
```

### Quick Deploy to Render

1. **Push to GitHub:**
```bash
git add .
git commit -m "Setup merged deployment"
git push origin main
```

2. **Create Render Service:**
- Go to [Render Dashboard](https://dashboard.render.com/)
- Click "New +" → "Web Service"
- Connect your GitHub repo: `ProthamD/Dedsec---HackNITR_2K26`
- Render will auto-detect `render.yaml`

3. **Set Environment Variables:**
```
MONGODB_URI=mongodb+srv://your-connection-string
JWT_SECRET=<auto-generated>
SESSION_SECRET=<auto-generated>
GOOGLE_GENERATIVE_AI_API_KEY=your-google-key
MISTRAL_API_KEY=your-mistral-key
NODE_ENV=production
PORT=3000
MASTRA_URL=http://localhost:4111
```

4. **Deploy:**
- Click "Create Web Service"
- Render will build and deploy automatically
- Get your URL: `https://inventree-merged.onrender.com`

### Local Testing

Test the merged deployment locally:

```bash
# Install all dependencies
npm install
cd backend && npm install && cd ..
cd Inventree && npm install && cd ..

# Start merged service
npm start
```

This will start:
- Mastra on `http://localhost:4111`
- Backend on `http://localhost:3000`

### How It Works

1. **Chat Request Flow:**
   - User sends message via UI
   - Backend receives at `/api/chat`
   - Backend tries Mastra agent at `localhost:4111`
   - If Mastra unavailable → Falls back to local chat handler
   - Response returned to UI

2. **Deployment Benefits:**
   - ✅ Uses only 1 Render service (750 hours/month)
   - ✅ No network latency between services
   - ✅ Auto-sleeps after 15 min inactivity
   - ✅ Wakes in ~30 seconds on request

### MongoDB Setup (Free)

Use MongoDB Atlas free tier:

1. Go to [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. Create free M0 cluster
3. Add database user
4. Whitelist IP: `0.0.0.0/0` (allow all)
5. Get connection string
6. Add to Render env vars as `MONGODB_URI`

### Troubleshooting

**Service won't start:**
- Check Render logs for errors
- Verify all env vars are set
- Ensure Node version >=22.13.0

**Chat not working:**
- Check if Mastra started successfully in logs
- Look for "Mastra service on port 4111"
- Fallback to local handler should work automatically

**Slow first request:**
- Free tier services sleep after 15 min
- First request takes ~30s to wake
- Subsequent requests are instant

### Alternative: Separate Deployments

If you need separate services:

1. Deploy Inventree to Render (Mastra only)
2. Deploy backend to Vercel (UI only)
3. Update `MASTRA_URL` in backend to Inventree URL
